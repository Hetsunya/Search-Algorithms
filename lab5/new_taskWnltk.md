Отлично, теперь результаты выглядят намного лучше! Давайте проанализируем их и подведём итоги.

---

### Общие данные
- **Подготовка данных**: 2.1137 секунд (было 2.1298 с) — почти без изменений, стабильно из-за NLTK.
- **Размер словаря**: 7204 слов — остался таким же, что ожидаемо, так как изменения коснулись только IDF.
- **Количество документов**: 10 — без изменений.

---

### Анализ векторов запросов
1. **"затрепетали на ветру знамена"**: 
   - Вектор: `{'затрепета': 0.597, 'ветр': 0.270, 'знам': 0.270}` — значения выросли из-за новой формулы IDF (`log(1 + N/(df+1))`), что усиливает вес слов.

2. **"Гондора Мин-Риммон"**: 
   - Вектор: `{'гондор': 0.347, 'мин-риммон': 0.896}` — теперь "гондор" имеет ненулевое значение (0.347), что решает проблему с нулевым IDF. Это подтверждает, что новая формула работает.

3. **"рохиррим"**: 
   - Вектор: `{'рохирр': 0.887}` — значение увеличилось, что логично для редкого слова.

4. **"войске"**: 
   - Вектор: `{'войск': 0.747}` — тоже увеличилось, отражая более сильный вес.

---

### Анализ запросов

#### Запрос: "затрепетали на ветру знамена"
- **TF-IDF**: 
  - Топ-1: `часть_8.txt` (0.0323) — релевантный документ на первом месте.
  - Время: 0.003079 с (было 0.002394 с) — чуть медленнее, возможно, из-за случайных колебаний.
- **Простой подсчёт**: 
  - Топ-1: `часть_4.txt` (16), `часть_8.txt` на втором месте.
  - Время: 0.001664 с (было 0.001986 с).
- **Качество**: Precision: 0.1, Recall: 1.0, F1: 0.1818 — без изменений, так как релевантный только один.

#### Запрос: "Гондора Мин-Риммон"
- **TF-IDF**: 
  - Топ-5: `часть_1.txt` (0.0480), `часть_8.txt` (0.0403), `часть_4.txt` (0.0368), `часть_5.txt` (0.0297), `часть_3.txt` (0.0178).
  - Время: 0.003058 с (было 0.002890 с).
  - Успех: Теперь все сходства ненулевые, и `часть_8.txt` (единственный релевантный) в топ-2. Это подтверждает, что "гондор" теперь вносит вклад благодаря ненулевому IDF.
- **Простой подсчёт**: 
  - Топ-5: `часть_1.txt` (39), `часть_4.txt` (28), `часть_8.txt` (25), `часть_5.txt` (23), `часть_3.txt` (14).
  - Время: 0.001338 с (было 0.001056 с).
- **Качество**: Precision: 0.1, Recall: 1.0, F1: 0.1818 — низкая точность из-за одного релевантного документа.

#### Запрос: "рохиррим"
- **TF-IDF**: 
  - Топ-5: все релевантные, сходства выросли (например, `часть_4.txt` с 0.0491 до 0.0466`).
  - Время: 0.002696 с.
- **Простой подсчёт**: 
  - Топ-5: совпадает с TF-IDF.
  - Время: 0.000752 с.
- **Качество**: Precision: 0.6, Recall: 1.0, F1: 0.75 — всё стабильно.

#### Запрос: "войске"
- **TF-IDF**: 
  - Топ-5: все релевантные, сходства значительно выросли (например, `часть_4.txt` с 0.0305 до 0.0824`).
  - Время: 0.002438 с.
- **Простой подсчёт**: 
  - Топ-5: совпадает с TF-IDF.
  - Время: 0.000914 с.
- **Качество**: Precision: 0.8, Recall: 1.0, F1: 0.8889 — всё в порядке.

---

### Что изменилось?

1. **Исправление IDF**:
   - Новая формула `log(1 + total_docs / (df + 1))` устранила проблему с нулевыми значениями IDF. Теперь даже слова, встречающиеся во всех документах (например, "гондор"), имеют ненулевой вес (0.347), что улучшило ранжирование для "Гондора Мин-Риммон".

2. **Результаты для "Гондора Мин-Риммон"**:
   - Ранее только `часть_8.txt` имела ненулевое сходство (0.0248), остальные были 0. Теперь все документы с "гондор" получили сходство, а `часть_8.txt` поднялась на второе место благодаря "мин-риммон".
   - Это показывает, что TF-IDF теперь корректно учитывает оба слова запроса.

3. **Общее качество**:
   - Для запросов с одним релевантным документом (1 и 2) Precision остаётся низким (0.1), так как возвращаются все 10 документов, но Recall 1.0 подтверждает, что релевантные найдены.
   - Для запросов с несколькими релевантными (3 и 4) метрики высокие, и топ-5 полностью совпадает с простым подсчётом.

---

### Несоответствие релевантных документов

- **"Гондора Мин-Риммон"**: 
  - Ранее было 9 релевантных, теперь только `часть_8.txt`. Это связано с тем, что `generate_relevant_docs` требует наличия всех токенов запроса ("гондор" и "мин-риммон"). Похоже, "мин-риммон" есть только в `часть_8.txt`, а "гондор" — везде.
  - Простой подсчёт показывает, что "гондор" встречается во многих документах (например, 39 раз в `часть_1.txt`), но "мин-риммон" ограничивает релевантность.

- **Проверка**:
  - Добавим отладочный вывод в `generate_relevant_docs`:
    ```python
    def generate_relevant_docs(queries, preprocessed_docs):
        relevant_docs = {}
        for query in queries:
            query_tokens = set(preprocess_text(query))
            print(f"Tokens for '{query}': {query_tokens}")
            relevant = []
            for doc_id, tokens in preprocessed_docs.items():
                doc_tokens = set(tokens)
                if query_tokens.issubset(doc_tokens):
                    relevant.append(doc_id)
            relevant_docs[query] = relevant if relevant else [list(preprocessed_docs.keys())[0]]
        return relevant_docs
    ```
  - Запустите и посмотрите токены для "Гондора Мин-Риммон". Если "мин-риммон" редок, это объясняет результат.

---

### Итог

1. **Успех**:
   - Проблема с нулевым IDF решена, "Гондора Мин-Риммон" теперь работает корректно с ненулевыми сходствами.
   - TF-IDF стал более точным благодаря улучшенной формуле.

2. **Скорость**:
   - TF-IDF: ~0.0024-0.0031 с, простой подсчёт: ~0.0007-0.0017 с — разрыв сохраняется, но оба метода быстрые.

3. **Рекомендация**:
   - Если релевантных документов для "Гондора Мин-Риммон" должно быть больше, проверьте тексты: возможно, "мин-риммон" действительно только в `часть_8.txt`. Если это ошибка, можно ослабить критерий в `generate_relevant_docs` (например, хотя бы одно слово из запроса).

Запустите с отладкой токенов и пришлите результат, если хотите уточнить релевантность! Иначе код готов для использования.